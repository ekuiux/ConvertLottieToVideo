import React, { useState, useRef, useEffect } from "react";
import axios from "axios";
import UploadLottieLayout from "./UploadLottieLayout";
import lottie from 'lottie-web';

function UploadLottie() {
  const [file, setFile] = useState(null);
  const [videoUrl, setVideoUrl] = useState("");
  const [loading, setLoading] = useState(false);
  const [showVideo, setShowVideo] = useState(false);
  const [fps, setFps] = useState("auto");
  const [isFpsDisabled, setIsFpsDisabled] = useState(false);
  const [inputKey, setInputKey] = useState(Date.now());
  const [progress, setProgress] = useState(0);
  const [snackbarOpen, setSnackbarOpen] = useState(false);
  const [snackbarMessage, setSnackbarMessage] = useState("");
  const [snackbarSeverity, setSnackbarSeverity] = useState("success");
  const fileInputRef = useRef(null);
  const videoCheckTimer = useRef(null);
  const lottieContainerRef = useRef(null);
  const [isVideoReady, setIsVideoReady] = useState(false);

  useEffect(() => {
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const lottieData = JSON.parse(event.target.result);
        lottie.loadAnimation({
          container: lottieContainerRef.current,
          renderer: 'svg',
          loop: true,
          autoplay: true,
          animationData: lottieData,
        });
      };
      reader.readAsText(file);
    }
  }, [file]);

  const handleFileChange = async (event) => {
    const selectedFile = event.target.files[0];
    if (!selectedFile) return;
  
    if (videoCheckTimer.current) {
      clearTimeout(videoCheckTimer.current);
    }
  
    try {
      await axios.post("http://localhost:5001/cancel");
      console.log("â›” ÐŸÑ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°");
    } catch (error) {
      console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¼ÐµÐ½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸:", error);
    }
  
    setFile(selectedFile);
    setVideoUrl("");
    setShowVideo(false);
    setLoading(false);
    setIsFpsDisabled(false);
    setIsVideoReady(false);
    setInputKey(Date.now());
  };

  const handleUpload = async () => {
    if (!file) {
      alert("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Lottie JSON Ñ„Ð°Ð¹Ð»!");
      return;
    }

    const formData = new FormData();
    formData.append("lottie", file);
    formData.append("fps", fps === "auto" ? "auto" : fps);

    setLoading(true);
    setIsFpsDisabled(true);

    try {
      const response = await axios.post("http://localhost:5001/convert", formData, {
        headers: { "Content-Type": "multipart/form-data" },
        onUploadProgress: (progressEvent) => {
          const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
          setProgress(percentCompleted);
        }
      });

      console.log('Ð¡ÐµÑ€Ð²ÐµÑ€ Ð²ÐµÑ€Ð½ÑƒÐ»:', response.data);
      const videoFileName = response.data.videoFileName;
      waitForVideo(videoFileName);
    } catch (error) {
      console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ñ„Ð°Ð¹Ð»Ð°:", error);
      setSnackbarMessage("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ„Ð°Ð¹Ð»Ð°");
      setSnackbarSeverity("error");
      setSnackbarOpen(true);
      setLoading(false);
      setIsFpsDisabled(false);
    }
  };

  const waitForVideo = async (videoFileName, attempts = 0, delay = 2000) => {
    if (!file) {
      console.log("ðŸš« ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°, Ñ‚Ð°Ðº ÐºÐ°Ðº Ñ„Ð°Ð¹Ð» Ð±Ñ‹Ð» Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½.");
      return;
    }
  
    const maxAttempts = 50;
    const videoPath = `http://localhost:5001/output/${videoFileName}?nocache=${Date.now()}`;
  
    console.log(`ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾ (Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° #${attempts + 1}/${maxAttempts})`);
  
    try {
      const response = await axios.head(videoPath);
      if (response.status === 200) {
        console.log("âœ… Ð’Ð¸Ð´ÐµÐ¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾:", videoPath);
        setVideoUrl(videoPath);
        setLoading(true);
        setIsFpsDisabled(true);
        setIsVideoReady(true);
  
        setTimeout(() => {
          console.log("ðŸŽ¬ ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾ Ñ‡ÐµÑ€ÐµÐ· 1 ÑÐµÐºÑƒÐ½Ð´Ñƒ.");
          setShowVideo(true);
          setLoading(false);
  
          setTimeout(() => {
            console.log("â³ Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾ Ñ‡ÐµÑ€ÐµÐ· 3 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹.");
            setShowVideo(false);
          }, 3 * 60 * 1000);
          
        }, 2000);
  
        return;
      }
    } catch (error) {
      console.error(`âŒ Ð’Ð¸Ð´ÐµÐ¾ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ (Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° #${attempts + 1}/${maxAttempts})`);
    }
  
    if (attempts >= maxAttempts) {
      console.error("ðŸš¨ ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¾ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº!");
      setLoading(false);
      setIsFpsDisabled(false);
      setSnackbarMessage("ÐžÑˆÐ¸Ð±ÐºÐ°: Ð²Ð¸Ð´ÐµÐ¾ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ.");
      setSnackbarSeverity("error");
      setSnackbarOpen(true);
      return;
    }
  
    if (attempts >= 5) delay = 4000;
    if (attempts >= 10) delay = 6000;
  
    videoCheckTimer.current = setTimeout(() => waitForVideo(videoFileName, attempts + 1, delay), delay);
  };

  const downloadVideo = async () => {
    if (!videoUrl) {
      alert("ÐžÑˆÐ¸Ð±ÐºÐ°: Ð²Ð¸Ð´ÐµÐ¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾!");
      return;
    }

    console.log("â¬‡ï¸ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð¸Ð´ÐµÐ¾:", videoUrl);
    const response = await fetch(videoUrl);
    const blob = await response.blob();
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "converted-video.mp4";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  const handleSnackbarClose = () => {
    setSnackbarOpen(false);
  };

  return (
    <UploadLottieLayout
      file={file}
      inputKey={inputKey}
      fileInputRef={fileInputRef}
      handleFileChange={handleFileChange}
      fps={fps}
      setFps={setFps}
      isFpsDisabled={isFpsDisabled}
      handleUpload={handleUpload}
      loading={loading}
      lottieContainerRef={lottieContainerRef}
      showVideo={showVideo}
      videoUrl={videoUrl}
      downloadVideo={downloadVideo}
      snackbarOpen={snackbarOpen}
      handleSnackbarClose={handleSnackbarClose}
      snackbarMessage={snackbarMessage}
      snackbarSeverity={snackbarSeverity}
      isVideoReady={isVideoReady}
    />
  );
}

export default UploadLottie;